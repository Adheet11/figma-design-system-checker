(()=>{"use strict";function e(e){return e.visible}function n(t,o,i){if((!("visible"in t)||e(t))&&("type"in t&&o(t),!(i&&"type"in t&&i(t))&&"children"in t))for(const e of t.children)n(e,o,i)}function t(e){const n=Math.round(255*e.r),t=Math.round(255*e.g),o=Math.round(255*e.b);return`#${n.toString(16).padStart(2,"0")}${t.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`}function o(e,n,t=.01){const o=Math.abs((e.r||0)-(n.r||0)),i=Math.abs((e.g||0)-(n.g||0)),s=Math.abs((e.b||0)-(n.b||0));let a=0;return"a"in e&&"a"in n&&(a=Math.abs(e.a-n.a)),o<=t&&i<=t&&s<=t&&a<=t}function i(e,n){const t=(e.r-n.r)*(e.r-n.r),o=(e.g-n.g)*(e.g-n.g),i=(e.b-n.b)*(e.b-n.b);let s=0;return"a"in e&&"a"in n?(s=(e.a-n.a)*(e.a-n.a),Math.sqrt(t+o+i+s)):Math.sqrt(t+o+i)}function s(e,n,t={r:1,g:0,b:0}){const o=figma.createRectangle();return o.name=`[Issue] ${n} - ${e.name}`,o.resize(e.width+4,e.height+4),o.x=e.absoluteTransform[0][2]-2,o.y=e.absoluteTransform[1][2]-2,o.fills=[{type:"SOLID",color:{r:0,g:0,b:0},opacity:0}],o.strokes=[{type:"SOLID",color:t}],o.strokeWeight=2,o.dashPattern=[4,4],o}function a(e){const n=[];if("SOLID"!==e.type)return n;const i=figma.getLocalPaintStyles();for(const s of i){if(1!==s.paints.length)continue;const i=s.paints[0];if("SOLID"===i.type&&o(i.color,e.color)){const e=Object.assign(Object.assign({},i.color),{a:1});n.push({name:s.name,id:s.id,value:t(e),source:"Local"})}}return n}function r(e,n){return e.length===n.length&&e.every(((e,t)=>{const i=n[t];if(e.type!==i.type)return!1;if(e.visible!==i.visible)return!1;if("DROP_SHADOW"===e.type||"INNER_SHADOW"===e.type){const n=e,t=i;return n.radius===t.radius&&n.offset.x===t.offset.x&&n.offset.y===t.offset.y&&n.spread===t.spread&&o(n.color,t.color)}if("LAYER_BLUR"===e.type||"BACKGROUND_BLUR"===e.type){const n=i;return e.radius===n.radius}return!0}))}function l(e){return e.map((e=>e.type)).join(", ")}function c(){const e={colorTokens:new Map,typographyTokens:new Map,spacingTokens:new Map,borderRadiusTokens:new Map,shadowTokens:new Map,fontFamilies:[]},n=figma.variables.getLocalVariableCollections();for(const t of n)if(t.name.includes("Design System")||t.name.includes("Tokens")||t.name.includes("DS")){const n=figma.variables.getVariablesByCollection(t.id);for(const t of n){const n=t.name.toLowerCase();n.includes("color")||n.includes("fill")||n.includes("background")||"COLOR"===t.resolvedType?e.colorTokens.set(t.id,t):n.includes("spacing")||n.includes("space")||n.includes("gap")||n.includes("padding")||n.includes("margin")?e.spacingTokens.set(t.id,t):n.includes("radius")||n.includes("corner")?e.borderRadiusTokens.set(t.id,t):n.includes("shadow")||n.includes("elevation")?e.shadowTokens.set(t.id,t):(n.includes("type")||n.includes("font")||n.includes("text")||n.includes("typography"))&&e.typographyTokens.set(t.id,t)}}return e}function d(e){const n={colorTokens:new Map,typographyTokens:new Map,spacingTokens:new Map,borderRadiusTokens:new Map,shadowTokens:new Map,fontFamilies:e.fontFamilies||[]},t=(e,n="id")=>{const t=new Map;return Array.isArray(e)&&e.forEach((e=>{e&&e[n]&&t.set(e[n],e)})),t};return e&&(e.colorTokens&&(n.colorTokens=Array.isArray(e.colorTokens)?t(e.colorTokens):e.colorTokens),e.typographyTokens&&(n.typographyTokens=Array.isArray(e.typographyTokens)?t(e.typographyTokens):e.typographyTokens),e.spacingTokens&&(n.spacingTokens=Array.isArray(e.spacingTokens)?t(e.spacingTokens):e.spacingTokens),e.borderRadiusTokens&&(n.borderRadiusTokens=Array.isArray(e.borderRadiusTokens)?t(e.borderRadiusTokens):e.borderRadiusTokens),e.shadowTokens&&(n.shadowTokens=Array.isArray(e.shadowTokens)?t(e.shadowTokens):e.shadowTokens)),n}function f(e,n,t,o,i){const s=figma.variables.getVariableById(t);if(!s)return;const a=figma.variables.getVariableCollectionById(s.variableCollectionId);if(a&&!(a.name.includes("Design System")||a.name.includes("Tokens")||a.name.includes("DS"))){let t=[];const r=a.modes[0].modeId,l=s.valuesByMode[r];"fills"===n||"strokes"===n?"COLOR"===s.resolvedType&&(t=y(l,o.colorTokens)):n.includes("Radius")?t=p(l,o.borderRadiusTokens):(n.includes("padding")||n.includes("Spacing")||"itemSpacing"===n)&&(t=p(l,o.spacingTokens)),i.push({node:{id:e.id,name:e.name,type:e.type},type:"variable",message:`Using non-design system variable for ${n}`,value:`${s.name} (${a.name})`,suggestions:t})}}function y(e,n){const o=[],s=[],a="a"in e?e:Object.assign(Object.assign({},e),{a:1});for(const[e,t]of n){const n=Object.keys(t.valuesByMode)[0],o=t.valuesByMode[n];if("object"==typeof o&&"r"in o){const n="a"in o?o:Object.assign(Object.assign({},o),{a:1});s.push({id:e,color:n,name:t.name})}}const r=function(e,n){if(0===n.length)return null;let t=null,o=Number.MAX_VALUE;for(const s of n){const n=i(e,s.color);n<o&&(o=n,t=Object.assign(Object.assign({},s),{distance:n}))}return t}(a,s);return r&&o.push({name:r.name,id:r.id,value:t(r.color),distance:r.distance}),o}function p(e,n){if(!n||n instanceof Map&&0===n.size||Array.isArray(n)&&0===n.length)return[];const t=n instanceof Map?g(n):n,o=t.filter((n=>n.value===e));return o.length>0?o.map((e=>({name:e.name,id:e.id,value:e.value.toString(),distance:0}))):t.map((n=>({token:n,distance:Math.abs(n.value-e)}))).filter((n=>n.distance/e<.1)).sort(((e,n)=>e.distance-n.distance)).slice(0,3).map((e=>({name:e.token.name,id:e.token.id,value:e.token.value.toString(),distance:e.distance})))}function m(e,n,o,i){if(!(i in e))return;const s="fills"===i?"fills"in e?e.fills:null:"strokes"in e?e.strokes:null;if(s&&"symbol"!=typeof s&&!(("fills"===i?"fillStyleId"in e&&e.fillStyleId:"strokeStyleId"in e&&e.strokeStyleId)||"boundVariables"in e&&e.boundVariables&&e.boundVariables[i]))for(const a of s)if(!1!==a.visible&&"SOLID"===a.type){const s=y(a.color,n.colorTokens);if(s.length>0){const n=t(Object.assign(Object.assign({},a.color),{a:1}));o.push({node:{id:e.id,name:e.name,type:e.type},type:"missingVariable",message:("fills"===i?"Fill":"Stroke")+" color should use a variable token",value:n,property:i,suggestions:s})}}}function u(e){return e.replace(/([A-Z])/g," $1").replace(/^./,(e=>e.toUpperCase()))}function g(e){const n=[];if(!e)return n;for(const[t,o]of e.entries())if(o&&o.valuesByMode)try{const e=Object.keys(o.valuesByMode);if(0===e.length)continue;const i=e[0],s=o.valuesByMode[i];"number"==typeof s&&s>0&&n.push({id:t,name:o.name,value:s})}catch(e){console.warn("Error processing variable in convertVariableMapToTokenInfoArray:",e)}return n}function h(e,n,t,o){const i=figma.createFrame();i.name=n,i.resize(288,28),i.fills=[{type:"SOLID",color:{r:.95,g:.95,b:.95}}],i.cornerRadius=4,i.layoutMode="HORIZONTAL",i.counterAxisAlignItems="CENTER",i.primaryAxisSizingMode="FIXED",i.counterAxisSizingMode="AUTO",i.paddingLeft=12,i.paddingRight=12,e.appendChild(i);const s=figma.createText();s.characters=n,s.fontSize=12,s.fontName={family:"Inter",style:"Regular"},i.appendChild(s);const a=figma.createText();a.characters=t,a.fontSize=12,a.fontName={family:"Inter",style:"Medium"},a.fills=[{type:"SOLID",color:o}],a.layoutAlign="STRETCH",a.textAlignHorizontal="RIGHT",i.appendChild(a)}function b(e){return e<50?{r:.9,g:.3,b:.3}:e<80?{r:1,g:.6,b:.1}:{r:.3,g:.7,b:.3}}var v=function(e,n,t,o){return new(t||(t=Promise))((function(i,s){function a(e){try{l(o.next(e))}catch(e){s(e)}}function r(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,r)}l((o=o.apply(e,n||[])).next())}))};function k(e){return v(this,void 0,void 0,(function*(){try{const n=yield figma.teamLibrary.getComponentMetadataAsync(e.id);for(const t of n)e.components.push({id:t.key,key:t.key,name:t.name})}catch(n){console.error(`Error loading components for library ${e.name}:`,n)}}))}function S(e){return v(this,void 0,void 0,(function*(){try{const n=yield figma.teamLibrary.getStyleMetadataAsync(e.id);for(const t of n)e.styles.push({id:t.key,key:t.key,name:t.name,type:t.styleType})}catch(n){console.error(`Error loading styles for library ${e.name}:`,n)}}))}var T=function(e,n,t,o){return new(t||(t=Promise))((function(i,s){function a(e){try{l(o.next(e))}catch(e){s(e)}}function r(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,r)}l((o=o.apply(e,n||[])).next())}))};const C="cachedDesignSystems";function I(){return T(this,void 0,void 0,(function*(){try{return(yield figma.clientStorage.getAsync(C))||[]}catch(e){return console.error("Error getting cached design systems:",e),[]}}))}var w=function(e,n,t,o){return new(t||(t=Promise))((function(i,s){function a(e){try{l(o.next(e))}catch(e){s(e)}}function r(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,r)}l((o=o.apply(e,n||[])).next())}))};let A=null;function R(e,t="selection",o=!1){return w(this,void 0,void 0,(function*(){try{let i=null,a=null;A?(i=yield function(e){return T(this,void 0,void 0,(function*(){try{return(yield I()).find((n=>n.id===e))||null}catch(e){return console.error("Error getting design system by ID:",e),null}}))}(A),a=i?function(e){const n=new Set;e.categorizedTokens.typographyTokens.forEach((e=>{const t=e.name.split("/");if(t.length>1){const e=t[1].trim();e&&n.add(e)}}));const t=new Map,o=new Map,i=new Map,s=new Map,a=new Map,r=(e,n)=>{e.forEach((e=>{e&&e.id&&n.set(e.id,e)}))};return r(e.categorizedTokens.colorTokens,t),r(e.categorizedTokens.typographyTokens,o),r(e.categorizedTokens.spacingTokens,i),r(e.categorizedTokens.borderRadiusTokens,s),r(e.categorizedTokens.shadowTokens,a),{colorTokens:t,typographyTokens:o,spacingTokens:i,borderRadiusTokens:s,shadowTokens:a,fontFamilies:Array.from(n)}}(i):yield c()):a=yield c();const r=function(e){if("selection"===e&&figma.currentPage.selection.length>0)return[...figma.currentPage.selection];if("page"===e||"selection"===e&&0===figma.currentPage.selection.length)return[...figma.currentPage.children];if("document"===e){const e=[];for(const n of figma.root.children)e.push(...n.children);return e}return[...figma.currentPage.children]}(t);figma.notify(`Analyzing design system usage (${t} scope)...`,{timeout:1e4});let l=[...function(){const e=[],n=figma.getLocalPaintStyles(),t=figma.getLocalTextStyles(),o=figma.getLocalEffectStyles(),i=figma.getLocalGridStyles(),s=figma.variables.getLocalVariableCollections(),a=n.length+t.length+o.length+i.length>30,r=figma.root.findAllWithCriteria({types:["COMPONENT","COMPONENT_SET"]}).length>10,l=s.length>0;if(a||r||l){const a={id:"local",name:figma.root.name,components:[],styles:[],variables:[]},r=figma.root.findAllWithCriteria({types:["COMPONENT"]});for(const e of r)a.components.push({id:e.id,key:e.key,name:e.name});for(const e of n)a.styles.push({id:e.id,key:e.key,name:e.name,type:"PAINT"});for(const e of t)a.styles.push({id:e.id,key:e.key,name:e.name,type:"TEXT"});for(const e of o)a.styles.push({id:e.id,key:e.key,name:e.name,type:"EFFECT"});for(const e of i)a.styles.push({id:e.id,key:e.key,name:e.name,type:"GRID"});for(const e of s){const n=figma.variables.getVariablesByCollection(e.id);for(const t of n)a.variables.push({id:t.id,name:t.name,resolvedType:t.resolvedType,collectionName:e.name})}e.push(a)}return e}()];if(!i||e&&e.includeTeamLibraries){const e=yield function(){return v(this,void 0,void 0,(function*(){const e=[];try{const n=yield figma.teamLibrary.getAvailableLibrariesAsync();for(const t of n)(t.name.includes("Design System")||t.name.includes("DS")||t.name.includes("Tokens")||t.name.includes("Components"))&&e.push({id:t.key,name:t.name,components:[],styles:[],variables:[]});for(const n of e)yield k(n),yield S(n)}catch(e){console.error("Error detecting libraries:",e)}return e}))}();l=[...l,...e]}let d=0,f=0;const y=1e3;for(const e of r)if(f+=E(e,y),f>=y){f=y;break}const p=[],m=[],u=[],g=50,C=Date.now();for(const e of r)if(yield L(e,p,m,u,a,g,(e=>{d+=e;const n=Math.min(100,Math.round(d/f*100));figma.notify(`Analyzing design system usage: ${n}%`,{timeout:1e4})}),o,C,6e4),Date.now()-C>6e4){figma.notify("Analysis stopped due to time limit - partial results shown",{timeout:5e3});break}const w=p.map((e=>{var n,t;return{node:{id:e.node.id,name:e.node.name,type:e.node.type},type:e.type,message:e.message,details:e.details,mainComponent:e.mainComponent,mainComponentId:null===(n=e.mainComponent)||void 0===n?void 0:n.id,mainComponentName:null===(t=e.mainComponent)||void 0===t?void 0:t.name}})),R=m.map((e=>{var n;return{node:{id:e.node.id,name:e.node.name,type:e.node.type},type:e.type,message:e.message,value:e.value,suggestions:null===(n=e.suggestions)||void 0===n?void 0:n.map((e=>({name:e.name,id:e.id,value:e.value,source:e.source})))}})),x=function(e,t){const o={totalNodes:0,libraryComponents:0,localComponents:0,modifiedComponents:0,detachedComponents:0,nodesWithStyles:0,nodesWithoutStyles:0,nodesWithVariables:0,nodesWithoutVariables:0,componentCoverage:0,styleCoverage:0,variableCoverage:0,overallCoverage:0},i=new Set;for(const t of e)n(t,(e=>{var n;if(!i.has(e.id)){if(i.add(e.id),o.totalNodes++,"INSTANCE"===e.type){const t=e;(null===(n=t.mainComponent)||void 0===n?void 0:n.remote)?o.libraryComponents++:t.mainComponent&&o.localComponents++}"fillStyleId"in e&&e.fillStyleId&&"symbol"!=typeof e.fillStyleId||"strokeStyleId"in e&&e.strokeStyleId&&"symbol"!=typeof e.strokeStyleId||"effectStyleId"in e&&e.effectStyleId&&"symbol"!=typeof e.effectStyleId||"TEXT"===e.type&&e.textStyleId&&"symbol"!=typeof e.textStyleId?o.nodesWithStyles++:("fills"in e&&e.fills&&"symbol"!=typeof e.fills&&e.fills.length>0||"strokes"in e&&e.strokes&&"symbol"!=typeof e.strokes&&e.strokes.length>0||"effects"in e&&e.effects&&"symbol"!=typeof e.effects&&e.effects.length>0||"TEXT"===e.type)&&o.nodesWithoutStyles++,"boundVariables"in e&&e.boundVariables&&Object.keys(e.boundVariables).length>0?o.nodesWithVariables++:("cornerRadius"in e&&e.cornerRadius&&0!==e.cornerRadius&&"symbol"!=typeof e.cornerRadius||"fills"in e&&e.fills&&"symbol"!=typeof e.fills&&e.fills.some((e=>"SOLID"===e.type))||"strokes"in e&&e.strokes&&"symbol"!=typeof e.strokes&&e.strokes.some((e=>"SOLID"===e.type)))&&o.nodesWithoutVariables++}}),(e=>{var n;return!("INSTANCE"!==e.type||!(null===(n=e.mainComponent)||void 0===n?void 0:n.remote))}));for(const e of t)"detached"===e.type?(o.detachedComponents++,o.libraryComponents--):e.type.startsWith("modified")&&(i.has("modified-"+e.node.id)||(i.add("modified-"+e.node.id),o.modifiedComponents++));o.libraryComponents+o.localComponents+o.detachedComponents>0&&(o.componentCoverage=o.libraryComponents/(o.libraryComponents+o.localComponents+o.detachedComponents)*100),o.nodesWithStyles+o.nodesWithoutStyles>0&&(o.styleCoverage=o.nodesWithStyles/(o.nodesWithStyles+o.nodesWithoutStyles)*100),o.nodesWithVariables+o.nodesWithoutVariables>0&&(o.variableCoverage=o.nodesWithVariables/(o.nodesWithVariables+o.nodesWithoutVariables)*100);const s=o.libraryComponents+o.localComponents+o.detachedComponents+o.nodesWithStyles+o.nodesWithoutStyles+o.nodesWithVariables+o.nodesWithoutVariables,a=o.libraryComponents+o.nodesWithStyles+o.nodesWithVariables;return s>0&&(o.overallCoverage=a/s*100),o}(r,w);if(x.scopeType?(x.scopeType=t,x.processingTime=Date.now()-C,x.nodesProcessed=d,x.totalNodesEstimate=f):Object.assign(x,{scopeType:t,processingTime:Date.now()-C,nodesProcessed:d,totalNodesEstimate:f}),(null==e?void 0:e.visualize)&&function(e,n,t){const o=figma.currentPage.findAll((e=>"RECTANGLE"===e.type&&e.name.startsWith("[Issue]")));for(const e of o)e.remove();const i=figma.createFrame();i.name="Design System Issues",i.fills=[],i.locked=!0,i.expanded=!1;for(const n of e){const e=figma.getNodeById(n.node.id);if(e){const t=s(e,n.message,{r:1,g:0,b:0});i.appendChild(t)}}for(const e of n){const n=figma.getNodeById(e.node.id);if(n){const t=s(n,e.message,{r:1,g:.6,b:0});i.appendChild(t)}}for(const e of t){const n=figma.getNodeById(e.node.id);if(n){const t=s(n,e.message,{r:1,g:.8,b:0});i.appendChild(t)}}0===i.children.length&&i.remove()}(w,R,u),(null==e?void 0:e.generateReport)&&r.length>0){let e=r[0];if("parent"in e&&e.parent&&"FRAME"===e.parent.type)e=e.parent;else if("FRAME"!==e.type){const n=figma.createFrame();n.name="Design System Report Frame",n.resize(600,400),e=n}!function(e,n){const t=figma.createFrame();t.name="Design System Coverage Report",t.resize(320,400),t.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],t.cornerRadius=8,t.x=n.x+n.width+40,t.y=n.y;const o=figma.createFrame();o.name="Header",o.resize(320,60),o.fills=[{type:"SOLID",color:{r:.9,g:.9,b:.9}}],o.x=0,o.y=0,t.appendChild(o);const i=figma.createText();i.characters="Design System Coverage",i.fontSize=18,i.x=16,i.y=16,i.fontName={family:"Inter",style:"Medium"},o.appendChild(i);const s=figma.createFrame();s.name="Overall Coverage",s.resize(288,80),s.fills=[{type:"SOLID",color:{r:.95,g:.95,b:.95}}],s.cornerRadius=4,s.x=16,s.y=76,t.appendChild(s);const a=figma.createText();a.characters="Overall Coverage",a.fontSize=14,a.x=16,a.y=16,a.fontName={family:"Inter",style:"Medium"},s.appendChild(a);const r=figma.createText();r.characters=`${e.overallCoverage.toFixed(1)}%`,r.fontSize=24,r.x=16,r.y=40,r.fontName={family:"Inter",style:"Bold"},e.overallCoverage<50?r.fills=[{type:"SOLID",color:{r:.9,g:.3,b:.3}}]:e.overallCoverage<80?r.fills=[{type:"SOLID",color:{r:1,g:.6,b:.1}}]:r.fills=[{type:"SOLID",color:{r:.3,g:.7,b:.3}}],s.appendChild(r);const l=figma.createFrame();l.name="Metrics",l.resize(288,228),l.fills=[],l.layoutMode="VERTICAL",l.primaryAxisSizingMode="AUTO",l.counterAxisSizingMode="FIXED",l.itemSpacing=8,l.x=16,l.y=172,t.appendChild(l),h(l,"Component Coverage",`${e.componentCoverage.toFixed(1)}%`,b(e.componentCoverage)),h(l,"Library Components",e.libraryComponents.toString(),{r:0,g:0,b:0}),h(l,"Local Components",e.localComponents.toString(),{r:0,g:0,b:0}),h(l,"Modified Components",e.modifiedComponents.toString(),{r:0,g:0,b:0}),h(l,"Style Coverage",`${e.styleCoverage.toFixed(1)}%`,b(e.styleCoverage)),h(l,"Variable Coverage",`${e.variableCoverage.toFixed(1)}%`,b(e.variableCoverage)),h(l,"Total Nodes",e.totalNodes.toString(),{r:0,g:0,b:0})}(x,e)}figma.ui.postMessage({type:"checkResults",payload:{componentResults:w,styleResults:R,tokenResults:u,metrics:x,libraries:l,activeDesignSystem:i}}),figma.notify("Design system check complete!")}catch(e){console.error("Error during design system check:",e),figma.notify("Error running design system check",{error:!0})}}))}function E(e,n,t=0){if((t+=1)>=n)return t;if("children"in e)for(const o of e.children)if((t=E(o,n,t))>=n)break;return t}function L(n,t,o,i,s,a,r,l,c,d){return w(this,void 0,void 0,(function*(){let f=[n],y=0;for(;f.length>0;){const n=f.shift();if(l||e(n)){if(x(n,t,o,i,s),y++,"children"in n&&(f=[...f,...n.children]),Date.now()-c>d)return void(y>0&&r(y));y>=a&&(r(y),y=0,yield new Promise((e=>setTimeout(e,0))))}}y>0&&r(y)}))}function x(n,o,i,s,c){try{if("INSTANCE"===n.type){const e=function(e){const n=[],t=function(e){return!!e.mainComponent&&null!==e.mainComponent.remote}(e);return e.mainComponent?!t&&e.mainComponent?n.push({node:e,type:"nonLibrary",message:"Component is not from a team library",details:"Using team library components improves consistency",mainComponent:e.mainComponent}):e.mainComponent&&function(e,n){const t=function(e){const n=[],t=function(e){const n=[];return function e(t){if("TEXT"===t.type&&n.push(t),"children"in t)for(const n of t.children)e(n)}(e),n}(e);for(const e of t){const t=e.mainComponent;t&&e.characters!==t.characters&&n.push("text")}const o=function(e){const n=[];return function e(t){if("fills"in t&&t.fills&&t.fills.length>0&&n.push(t),"children"in t)for(const n of t.children)e(n)}(e),n}(e);for(const e of o){const t=e.mainComponent,o="fills"in e?e.fills:void 0,i=t?t.fills:void 0;t&&JSON.stringify(o)!==JSON.stringify(i)&&n.push("fills")}const i=function(e){const n=[];return function e(t){if("strokes"in t&&t.strokes&&t.strokes.length>0&&n.push(t),"children"in t)for(const n of t.children)e(n)}(e),n}(e);for(const e of i){const t=e.mainComponent,o="strokes"in e?e.strokes:void 0,i=t?t.strokes:void 0;t&&JSON.stringify(o)!==JSON.stringify(i)&&n.push("strokes")}return n}(e);t.length>0&&e.mainComponent&&(e.width===e.mainComponent.width&&e.height===e.mainComponent.height||"SCALE"===e.constraints.horizontal&&"SCALE"===e.constraints.vertical&&n.push({node:e,type:"modified-size",message:"Component size has been modified",details:`Size changed from ${e.mainComponent.width}×${e.mainComponent.height} to ${e.width}×${e.height}`,mainComponent:e.mainComponent}),t.length>2&&n.push({node:e,type:"modified-styles",message:"Component has significant style overrides",details:`${t.length} properties have been overridden`,mainComponent:e.mainComponent}),function(e,n){var t;if(e.mainComponent){if(e.name.toLowerCase().includes("button")){const o=function(e){const n=[];return function e(t){if("RECTANGLE"===t.type&&n.push(t),"children"in t)for(const n of t.children)e(n)}(e),n}(e);for(const i of o){const o=i.cornerRadius,s=null===(t=i.boundVariables)||void 0===t?void 0:t.cornerRadius;if(void 0!==o&&o!==s){n.push({node:e,type:"modified-forbidden",message:"Button component has modified corner radius",details:"Button corner radii should be standardized across the design system",mainComponent:e.mainComponent});break}}}if(e.name.toLowerCase().includes("card")){const t=function(e){const n=[];return function e(t){if("effects"in t&&t.effects&&t.effects.length>0&&n.push(t),"children"in t)for(const n of t.children)e(n)}(e),n}(e);for(const o of t){const t=o;if(t.effects&&t.effects.length>0&&!t.effectStyleId){n.push({node:e,type:"modified-forbidden",message:"Card component has modified shadow",details:"Card shadows should use the design system standard elevation tokens",mainComponent:e.mainComponent});break}}}}}(e,n))}(e,n):n.push({node:e,type:"detached",message:"Component is detached from its main component",details:"Detached components lose their connection to the design system"}),n}(n);o.push(...e)}try{const e=function(e){const n=[];if(!("fills"in e)||"symbol"==typeof e.fills)return n;if(!e.fills||0===e.fills.length||!e.visible)return n;const o=e.fills.filter((e=>!1!==e.visible));if(0===o.length)return n;if(!e.fillStyleId&&o.length>0)for(const i of o)if("SOLID"===i.type&&!e.fillStyleId){const o=i.color,s=t({r:o.r,g:o.g,b:o.b,a:1});n.push({node:{id:e.id,name:e.name,type:e.type},type:"fill",message:"Node has fill without a style",value:s,suggestions:[]})}if("fills"in e&&"symbol"!=typeof e.fills&&e.fills.length>1){const t=e.fills.filter((e=>"SOLID"===e.type&&!1!==e.visible));t.length>1&&!e.fillStyleId&&n.push({node:{id:e.id,name:e.name,type:e.type},type:"fill",message:"Multiple solid fills without a style",value:`${t.length} solid fills`,suggestions:[]})}return n}(n);i.push(...e)}catch(e){console.warn(`Error checking fills for ${n.name}:`,e)}try{const e=function(e){const n=[];if(!("strokes"in e)||!e.strokes)return n;if("symbol"==typeof e.strokes)return n;if("strokeStyleId"in e&&!e.strokeStyleId){const o=e.strokes;if(0===o.length||!o.some((e=>!1!==e.visible)))return n;for(const i of o)if(!1!==i.visible&&"SOLID"===i.type){const o=t(Object.assign(Object.assign({},i.color),{a:1})),s=a(i);n.push({node:{id:e.id,name:e.name,type:e.type},type:"stroke",message:"Missing stroke style",value:o,suggestions:s})}}return n}(n);i.push(...e)}catch(e){console.warn(`Error checking strokes for ${n.name}:`,e)}try{const e=function(e){const n=[];if("TEXT"!==e.type)return n;if(!e.textStyleId){const t=`${"symbol"==typeof e.fontName?"Mixed fonts":`${e.fontName.family} ${e.fontName.style}`}, ${"symbol"==typeof e.fontSize?"Mixed sizes":`${e.fontSize}px`}`,o=function(e){const n=[];if("symbol"==typeof e.fontName||"symbol"==typeof e.fontSize)return n;const t=figma.getLocalTextStyles();for(const o of t)o.fontName.family===e.fontName.family&&o.fontName.style===e.fontName.style&&o.fontSize===e.fontSize&&n.push({name:o.name,id:o.id,value:`${o.fontName.family} ${o.fontName.style}, ${o.fontSize}px`,source:"Local"});return n}(e);n.push({node:{id:e.id,name:e.name,type:e.type},type:"text",message:"Missing text style",value:t,suggestions:o})}return n}(n);i.push(...e)}catch(e){console.warn(`Error checking text styles for ${n.name}:`,e)}try{const e=function(e){const n=[];return"effects"in e&&e.effects?("symbol"==typeof e.effects||"effectStyleId"in e&&!e.effectStyleId&&function(e,n,t){if(0===n.length)return;const o=n.map((e=>"DROP_SHADOW"===e.type?"Drop Shadow":"INNER_SHADOW"===e.type?"Inner Shadow":"LAYER_BLUR"===e.type?"Layer Blur":"BACKGROUND_BLUR"===e.type?"Background Blur":e.type)).join(", "),i=function(e){const n=[],t=figma.getLocalEffectStyles();for(const o of t){const t=[...o.effects];r(e,t)&&n.push({name:o.name,id:o.id,value:l(t),source:"Local"})}return n}(n);t.push({node:{id:e.id,name:e.name,type:e.type},type:"effect",message:"Missing effect style",value:o,suggestions:i})}(e,[...e.effects],n),n):n}(n);i.push(...e)}catch(e){console.warn(`Error checking effects for ${n.name}:`,e)}try{if(c){const e=function(e,n){const t=d(n),o=[];if(!("boundVariables"in e)||!e.boundVariables)return o;const i=["fills","strokes","effects","layoutGrids","opacity","cornerRadius","topLeftRadius","topRightRadius","bottomLeftRadius","bottomRightRadius","paddingLeft","paddingRight","paddingTop","paddingBottom","itemSpacing","counterAxisSpacing","strokeWeight","strokeTopWeight","strokeRightWeight","strokeBottomWeight","strokeLeftWeight"];for(const n of i){const i=e.boundVariables;if(n in i)if(Array.isArray(i[n]))for(const s of i[n])f(e,n,s.id,t,o);else f(e,n,i[n].id,t,o)}return o}(n,c);s.push(...e)}}catch(e){console.warn(`Error checking variables for ${n.name}:`,e)}try{if(c){const t=function(n,t){const o=d(t),i=[];if(!e(n)||(s=n.type,["CONNECTOR","SHAPE_WITH_TEXT","STICKY","CODE_BLOCK","WIDGET"].includes(s)))return i;var s;if("fills"in n&&n.fills&&"symbol"!=typeof n.fills&&m(n,o,i,"fills"),"strokes"in n&&n.strokes&&"symbol"!=typeof n.strokes&&m(n,o,i,"strokes"),"cornerRadius"in n&&"number"==typeof n.cornerRadius&&n.cornerRadius>0&&function(e,n,t){if(!("cornerRadius"in e))return;const o=e.cornerRadius;if("number"!=typeof o||0===o)return;if("boundVariables"in e&&e.boundVariables&&e.boundVariables.cornerRadius)return;const i=p(o,g(n.borderRadiusTokens));i.length>0&&t.push({node:{id:e.id,name:e.name,type:e.type},type:"missingVariable",message:"Border radius should use a variable token",value:o.toString(),property:"cornerRadius",suggestions:i})}(n,o,i),"itemSpacing"in n&&"number"==typeof n.itemSpacing){const e=g(o.spacingTokens),t=p(n.itemSpacing,e),s="boundVariables"in n&&n.boundVariables&&n.boundVariables.itemSpacing;t.length>0&&!s&&i.push({node:{id:n.id,name:n.name,type:n.type},type:"missingVariable",message:"Layout spacing should use a spacing token",value:n.itemSpacing.toString(),suggestions:t})}return("paddingLeft"in n||"paddingRight"in n||"paddingTop"in n||"paddingBottom"in n)&&function(e,n,t){const o=["paddingLeft","paddingRight","paddingTop","paddingBottom"],i=g(n.spacingTokens);for(const n of o)if(n in e&&"number"==typeof e[n]&&e[n]>0){const o=e[n];if(!("boundVariables"in e&&e.boundVariables&&e.boundVariables[n])){const s=p(o,i);s.length>0&&t.push({node:{id:e.id,name:e.name,type:e.type},type:"missingVariable",message:`${u(n)} should use a spacing token`,value:o.toString(),property:n,suggestions:s})}}}(n,o,i),"TEXT"===n.type&&function(e,n,t){if(e.textStyleId)return;const o=g(n.typographyTokens),i=[{prop:"fontSize",message:"Font size"},{prop:"lineHeight",message:"Line height"},{prop:"letterSpacing",message:"Letter spacing"}];for(const{prop:n,message:s}of i)if(n in e&&"number"==typeof e[n]&&e[n]>0){const i=e[n];if(!("boundVariables"in e&&e.boundVariables&&e.boundVariables[n])){const a=p(i,o);a.length>0&&t.push({node:{id:e.id,name:e.name,type:e.type},type:"missingVariable",message:`${s} should use a typography token`,value:i.toString(),property:n,suggestions:a})}}if(e.fontName&&"symbol"!=typeof e.fontName&&!("boundVariables"in e&&e.boundVariables&&e.boundVariables.fontName)){const o=n.fontFamilies||[];!o.includes(e.fontName.family)&&o.length>0&&t.push({node:{id:e.id,name:e.name,type:e.type},type:"missingVariable",message:"Font family not from design system",value:`${e.fontName.family} ${e.fontName.style}`,property:"fontName",suggestions:[]})}}(n,o,i),i}(n,c);s.push(...t)}}catch(e){console.warn(`Error checking missing variables for ${n.name}:`,e)}}catch(e){console.warn(`Error processing node ${n.name}:`,e)}}function M(e){return w(this,void 0,void 0,(function*(){try{const n=figma.getNodeById(e.nodeId);if(!n)return void figma.notify("Node not found",{error:!0});"style"===e.type?yield function(e,n){return w(this,void 0,void 0,(function*(){if("Local"!==n.style.source)try{const t=yield figma.importStyleByKeyAsync(n.style.key);"fill"===n.styleType&&"fillStyleId"in e?e.fillStyleId=t.id:"stroke"===n.styleType&&"strokeStyleId"in e?e.strokeStyleId=t.id:"effect"===n.styleType&&"effectStyleId"in e?e.effectStyleId=t.id:"text"===n.styleType&&"TEXT"===e.type&&(e.textStyleId=t.id)}catch(e){throw console.error("Error importing style:",e),new Error("Failed to import style from library")}else"fill"===n.styleType&&"fillStyleId"in e?e.fillStyleId=n.style.id:"stroke"===n.styleType&&"strokeStyleId"in e?e.strokeStyleId=n.style.id:"effect"===n.styleType&&"effectStyleId"in e?e.effectStyleId=n.style.id:"text"===n.styleType&&"TEXT"===e.type&&(e.textStyleId=n.style.id)}))}(n,e):"variable"===e.type?yield function(e,n){return w(this,void 0,void 0,(function*(){const t=figma.variables.getVariableById(n.variable.id);if(!t)throw new Error("Variable not found");switch(n.property){case"fills":"fills"in e&&e.setBoundVariable("fills",0,t);break;case"strokes":"strokes"in e&&e.setBoundVariable("strokes",0,t);break;case"cornerRadius":"cornerRadius"in e&&e.setBoundVariable("cornerRadius",t);break;case"topLeftRadius":case"topRightRadius":case"bottomLeftRadius":case"bottomRightRadius":n.property in e&&e.setBoundVariable(n.property,t);break;default:throw new Error(`Unsupported property: ${n.property}`)}}))}(n,e):"component"===e.type&&(yield function(e,n){return w(this,void 0,void 0,(function*(){if("INSTANCE"!==e.type)throw new Error("Node is not an instance");if("reset"===n.fixType)e.resetOverrides();else if("swap"===n.fixType)try{const t=(yield figma.importComponentByKeyAsync(n.componentKey)).createInstance();if(t.x=e.x,t.y=e.y,t.resize(e.width,e.height),e.parent){const n=e.parent.children.indexOf(e);e.parent.insertChild(n,t)}e.remove()}catch(e){throw console.error("Error swapping component:",e),new Error("Failed to swap component")}}))}(n,e)),figma.notify("Fix applied successfully!")}catch(e){console.error("Error applying fix:",e),figma.notify("Error applying fix",{error:!0})}}))}figma.showUI(__html__,{width:560,height:640}),figma.ui.onmessage=e=>w(void 0,void 0,void 0,(function*(){var n,t,o,i,s,a;try{if("init"===e.type){const e=yield I(),n=yield figma.clientStorage.getAsync("activeDesignSystemId");A=n||null,figma.ui.postMessage({type:"designSystemsLoaded",payload:{systems:e,activeId:A}})}else if("loadDesignSystem"===e.type){const n=e.payload.fileKey,t=yield function(e){return T(this,void 0,void 0,(function*(){try{figma.notify("Loading design system...",{timeout:6e4});const n=(yield figma.teamLibrary.getAvailableLibrariesAsync()).find((n=>n.key===e));if(!n)return figma.notify("Design system file not found",{error:!0}),null;const t={id:e,name:n.name,lastUpdated:Date.now(),components:[],styles:[],variables:[],categorizedTokens:{colorTokens:[],typographyTokens:[],spacingTokens:[],borderRadiusTokens:[],shadowTokens:[]}};try{const n=yield figma.teamLibrary.getComponentMetadataAsync(e);for(const e of n)t.components.push({id:e.key,key:e.key,name:e.name})}catch(e){console.error("Error loading components:",e)}try{const n=yield figma.teamLibrary.getStyleMetadataAsync(e);for(const e of n)t.styles.push({id:e.key,key:e.key,name:e.name,type:e.styleType})}catch(e){console.error("Error loading styles:",e)}return yield function(e){return T(this,void 0,void 0,(function*(){try{const n=(yield figma.clientStorage.getAsync(C))||[],t=n.findIndex((n=>n.id===e.id));t>=0?n[t]=e:n.push(e),yield figma.clientStorage.setAsync(C,n)}catch(e){console.error("Error saving design system to cache:",e)}}))}(t),t}catch(e){return console.error("Error loading design system file:",e),null}}))}(n);if(t){A=t.id,yield figma.clientStorage.setAsync("activeDesignSystemId",A);const e=yield I();figma.ui.postMessage({type:"designSystemsLoaded",payload:{systems:e,activeId:A}})}}else if("setActiveDesignSystem"===e.type)A=e.payload.id,yield figma.clientStorage.setAsync("activeDesignSystemId",A),figma.ui.postMessage({type:"activeDesignSystemChanged",payload:{activeId:A}});else if("deleteDesignSystem"===e.type){yield function(e){return T(this,void 0,void 0,(function*(){try{const n=((yield figma.clientStorage.getAsync(C))||[]).filter((n=>n.id!==e));yield figma.clientStorage.setAsync(C,n)}catch(e){console.error("Error deleting design system:",e)}}))}(e.payload.id),A===e.payload.id&&(A=null,yield figma.clientStorage.setAsync("activeDesignSystemId",null));const n=yield I();figma.ui.postMessage({type:"designSystemsLoaded",payload:{systems:n,activeId:A}})}else if("checkDesignSystem"===e.type){figma.notify("Analyzing design system usage...",{timeout:1e4});const a=(null===(t=null===(n=e.payload)||void 0===n?void 0:n.options)||void 0===t?void 0:t.scope)||"selection",r=(null===(i=null===(o=e.payload)||void 0===o?void 0:o.options)||void 0===i?void 0:i.includeHidden)||!1;yield R(null===(s=e.payload)||void 0===s?void 0:s.options,a,r)}else if("highlightNode"===e.type){const n=e.payload.nodeId,t=figma.getNodeById(n);t&&(figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]))}else"applyFix"===e.type?(yield M(e.payload.fix),yield R(void 0,"current",!1)):"applyBatchFixes"===e.type?yield function(e){return w(this,void 0,void 0,(function*(){figma.notify(`Applying ${e.length} fixes...`,{timeout:1e4});let n=0,t=0;for(let o=0;o<e.length;o+=10){const i=e.slice(o,o+10);for(const e of i)try{yield M(e),n++}catch(e){console.error(`Error applying fix ${o}:`,e),t++}figma.notify(`Applied ${o+i.length} of ${e.length} fixes...`,{timeout:1e4}),yield new Promise((e=>setTimeout(e,100)))}figma.notify(`Applied ${n} fixes successfully. ${t} fixes failed.`),figma.ui.postMessage({type:"batchFixComplete",payload:{totalFixes:e.length,successCount:n,failCount:t}})}))}(e.payload.fixes):"exportReport"===e.type?(a=e.payload.metrics,figma.ui.postMessage({type:"exportReportData",payload:JSON.stringify(a,null,2)})):"close"===e.type&&figma.closePlugin()}catch(e){console.error("Error handling message:",e),figma.notify("An unexpected error occurred",{error:!0}),figma.ui.postMessage({type:"error",payload:{message:e.message||"Unknown error"}})}})),function(){w(this,void 0,void 0,(function*(){if("check-design-system"===figma.command)yield R({visualize:!0},"page",!1);else if("configure-settings"===figma.command);else{const e=yield I(),n=yield figma.clientStorage.getAsync("activeDesignSystemId");A=n||null,figma.ui.postMessage({type:"designSystemsLoaded",payload:{systems:e,activeId:A}})}}))}()})();